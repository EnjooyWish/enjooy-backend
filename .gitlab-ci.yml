stages: 
 - build
 - deploy

cache:
   paths:
   - target


variables:
 MAVEN_OPTS: "-Dmaven.repo.local=/m2 -Dmaven.test.skip=true"

build:
 stage: build 
 script:
   - mvn $MAVEN_OPTS clean install
   - mv target/*.jar target/authentication.jar

local_deploy:
 stage: deploy
 before_script:
   - microdnf install which
   - 'which ssh-agent || ( microdnf install openssh-clients )'
   - eval $(ssh-agent -s)
   - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
   - mkdir -p ~/.ssh
   - chmod 700 ~/.ssh
   - ssh-keyscan 192.168.170.2 >> ~/.ssh/known_hosts
   - chmod 644 ~/.ssh/known_hosts
   - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
 script:
   - ssh root@192.168.170.2 "systemctl stop authentication.service"
   - scp -r target/*.jar root@192.168.170.2:/usr/orangeline/ && ssh root@192.168.170.2 "systemctl start authentication.service"	
 only:
   - master
# when: manual

ibar_deploy:
 stage: deploy
 before_script:
   - microdnf install which
   - 'which ssh-agent || ( microdnf install openssh-clients )'
   - eval $(ssh-agent -s)
   - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
   - mkdir -p ~/.ssh
   - chmod 700 ~/.ssh
   - ssh-keyscan 172.31.64.49 >> ~/.ssh/known_hosts
   - chmod 644 ~/.ssh/known_hosts
   - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
 script:
   - ls -l target/
   - ssh support@172.31.64.49 "sudo systemctl stop authentication.service"
   - scp -r target/*.jar support@172.31.64.49:/usr/orangeline/ && ssh support@172.31.64.49 "sudo systemctl start authentication.service"	
 only:
   - master
 when: manual

ipeksu_deploy:
 stage: deploy
 before_script:
   - microdnf install which
   - 'which ssh-agent || ( microdnf install openssh-clients )'
   - eval $(ssh-agent -s)
   - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
   - mkdir -p ~/.ssh
   - chmod 700 ~/.ssh
   - ssh-keyscan 192.168.1.55 >> ~/.ssh/known_hosts
   - chmod 644 ~/.ssh/known_hosts
   - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
 script:
   - ls -l target/
   - ssh root@192.168.1.55 "systemctl stop authentication.service"
   - scp -r target/*.jar root@192.168.1.55:/usr/orangeline/ && ssh root@192.168.1.55 "systemctl start authentication.service"
 only:
   - master
 when: manual

ady_deploy:
 stage: deploy
 before_script:
   - microdnf install which
   - 'which ssh-agent || ( microdnf install openssh-clients )'
   - eval $(ssh-agent -s)
   - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
   - mkdir -p ~/.ssh
   - chmod 700 ~/.ssh
   - ssh-keyscan -p 2233 192.168.6.33 >> ~/.ssh/known_hosts
   - chmod 644 ~/.ssh/known_hosts
   - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
 script:
   - ls -l target/
   - ssh appadmin@192.168.6.33 -p 2233 "sudo systemctl stop authentication.service"
   - scp -P 2233 -r target/*.jar appadmin@192.168.6.33:/usr/orangeline/ && ssh appadmin@192.168.6.33 -p 2233 "sudo systemctl start authentication.service"	
 only:
   - master
 when: manual

atb_deploy:
 stage: deploy
 before_script:
   - microdnf install which
   - 'which ssh-agent || ( microdnf install openssh-clients )'
   - eval $(ssh-agent -s)
   - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
   - mkdir -p ~/.ssh
   - chmod 700 ~/.ssh
   - ssh-keyscan 10.0.18.13 >> ~/.ssh/known_hosts
   - chmod 644 ~/.ssh/known_hosts
   - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
 script:
   - ls -l target/
   - ssh root@10.0.18.13 "systemctl stop authentication.service"
   - scp -r target/*.jar root@10.0.18.13:/usr/orangeline/ && ssh root@10.0.18.13 "systemctl start authentication.service"	
 only:
   - master
 when: manual

moe_deploy:
 stage: deploy
 before_script:
   - microdnf install which
   - 'which ssh-agent || ( microdnf install openssh-clients )'
   - eval $(ssh-agent -s)
   - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
   - mkdir -p ~/.ssh
   - chmod 700 ~/.ssh
   - ssh-keyscan 192.168.110.152 >> ~/.ssh/known_hosts
   - chmod 644 ~/.ssh/known_hosts
   - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
 script:
   - ls -l target/
   - ssh emin@192.168.110.152 "sudo systemctl stop authentication.service"
   - scp -r target/*.jar emin@192.168.110.152:/usr/orangeline/ && ssh emin@192.168.110.152 "sudo systemctl start authentication.service"	
 only:
   - master
 when: manual
